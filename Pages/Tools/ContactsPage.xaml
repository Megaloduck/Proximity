<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Proximity.Pages.Tools.ContactsPage"
             Title="{Binding PeerName}">

    <Grid RowDefinitions="Auto,*,Auto" 
          Padding="10"
          RowSpacing="10">

        <!-- Chat Header with Peer Info -->
        <Border Grid.Row="0"
                BackgroundColor="{DynamicResource CardBackgroundColor}"
                Stroke="{DynamicResource PrimaryColor}"
                StrokeThickness="1"
                StrokeShape="RoundRectangle 12"
                Padding="15">

            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                <!-- Avatar -->
                <Border Grid.Column="0"
                        WidthRequest="45"
                        HeightRequest="45"
                        StrokeShape="RounddRectangle 22"
                        BackgroundColor="{DynamicResource PrimaryColor}">
                    <Label Text="{Binding PeerAvatar, TargetNullValue='ðŸ‘¤'}"
                           FontSize="24"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"/>
                </Border>

                <!-- Peer Info -->
                <VerticalStackLayout Grid.Column="1" Spacing="3" VerticalOptions="Center">
                    <Label Text="{Binding PeerName}"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource PrimaryTextColor}"/>
                    <HorizontalStackLayout Spacing="8">
                        <Label Text="{Binding PeerStatus}"
                               FontSize="12"
                               TextColor="{DynamicResource SuccessColor}"/>
                        <Label Text="â€¢" 
                               FontSize="12"
                               TextColor="{DynamicResource TertiaryTextColor}"/>
                        <Label Text="{Binding PeerIpAddress}"
                               FontSize="12"
                               TextColor="{DynamicResource TertiaryTextColor}"/>
                    </HorizontalStackLayout>
                </VerticalStackLayout>

                <!-- Typing Indicator -->
                <Label Grid.Column="2"
                       Text="âœï¸ typing..."
                       FontSize="11"
                       IsVisible="{Binding IsTyping}"
                       TextColor="{DynamicResource AccentColor}"
                       VerticalOptions="Center"/>
            </Grid>
        </Border>

        <!-- Messages List -->
        <Border Grid.Row="1"
                BackgroundColor="{DynamicResource CardBackgroundColor}"
                Stroke="{DynamicResource BorderColor}"
                StrokeThickness="1">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="12"/>
            </Border.StrokeShape>

            <CollectionView ItemsSource="{Binding Messages}"
                           x:Name="MessagesCollection"
                           EmptyView="No messages yet. Start chatting!"
                           Margin="10">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="8" ColumnSpacing="10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="{Binding IsSentByMe, Converter={StaticResource BoolToGridLength}}"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="{Binding IsSentByMe, Converter={StaticResource InverseBoolToGridLength}}"/>
                            </Grid.ColumnDefinitions>

                            <!-- Message Bubble -->
                            <Border Grid.Column="1"
                                    Padding="12"
                                    MaximumWidthRequest="300">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="15"/>
                                </Border.StrokeShape>
                                <Border.Triggers>
                                    <!-- Sent by me -->
                                    <DataTrigger TargetType="Border" 
                                               Binding="{Binding IsSentByMe}" 
                                               Value="True">
                                        <Setter Property="BackgroundColor" Value="{DynamicResource PrimaryColor}"/>
                                        <Setter Property="HorizontalOptions" Value="End"/>
                                    </DataTrigger>
                                    <!-- Received -->
                                    <DataTrigger TargetType="Border" 
                                               Binding="{Binding IsSentByMe}" 
                                               Value="False">
                                        <Setter Property="BackgroundColor" Value="{DynamicResource SecondaryColor}"/>
                                        <Setter Property="HorizontalOptions" Value="Start"/>
                                    </DataTrigger>
                                </Border.Triggers>

                                <VerticalStackLayout Spacing="5">
                                    <!-- Sender Name (only for received messages) -->
                                    <Label Text="{Binding SenderName}"
                                           FontSize="12"
                                           FontAttributes="Bold"
                                           TextColor="White"
                                           IsVisible="{Binding IsSentByMe, Converter={StaticResource InvertedBoolConverter}}"/>

                                    <!-- Message Content -->
                                    <Label Text="{Binding Content}"
                                           FontSize="14"
                                           TextColor="White"/>

                                    <!-- Timestamp and Status -->
                                    <HorizontalStackLayout Spacing="6" HorizontalOptions="End">
                                        <Label Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
                                               FontSize="11"
                                               TextColor="White"
                                               Opacity="0.8"/>

                                        <!-- Delivery Status (only for sent messages) -->
                                        <Label Text="{Binding DeliveryStatus}"
                                               FontSize="11"
                                               IsVisible="{Binding IsSentByMe}"
                                               TextColor="White"
                                               Opacity="0.8">
                                            <Label.Triggers>
                                                <DataTrigger TargetType="Label" 
                                                           Binding="{Binding IsDelivered}" 
                                                           Value="True">
                                                    <Setter Property="Text" Value="âœ“âœ“"/>
                                                </DataTrigger>
                                                <DataTrigger TargetType="Label" 
                                                           Binding="{Binding IsDelivered}" 
                                                           Value="False">
                                                    <Setter Property="Text" Value="âœ“"/>
                                                </DataTrigger>
                                            </Label.Triggers>
                                        </Label>
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Border>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Border>

        <!-- Input Section with Voice -->
        <Border Grid.Row="2"
                BackgroundColor="{DynamicResource CardBackgroundColor}"
                Stroke="{DynamicResource BorderColor}"
                StrokeThickness="1"
                Padding="12">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="12"/>
            </Border.StrokeShape>

            <Grid RowDefinitions="Auto,Auto" RowSpacing="8">
                <!-- Voice Call Status Bar (when active) -->
                <Border Grid.Row="0"
                        IsVisible="{Binding IsVoiceActive}"
                        BackgroundColor="{DynamicResource SuccessColor}"
                        Padding="10"
                        StrokeShape="RoundRectangle 8">
                    <HorizontalStackLayout Spacing="10" HorizontalOptions="Center">
                        <Label Text="ðŸŽ¤"
                               FontSize="16"
                               VerticalOptions="Center"/>
                        <Label Text="Voice Call Active"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="White"
                               VerticalOptions="Center"/>
                        <Label Text="{Binding CallDuration}"
                               FontSize="14"
                               TextColor="White"
                               VerticalOptions="Center"/>
                    </HorizontalStackLayout>
                </Border>

                <!-- Message Input Row -->
                <Grid Grid.Row="1" ColumnDefinitions="*,Auto,Auto,Auto" ColumnSpacing="8">
                    <!-- Message Entry -->
                    <Border Grid.Column="0"
                            BackgroundColor="{DynamicResource PageBackgroundColor}"
                            Stroke="{DynamicResource BorderColor}"
                            StrokeThickness="1"
                            StrokeShape="RoundRectangle 20">
                        <Entry Text="{Binding MessageText}"
                               Placeholder="Type a message..."
                               PlaceholderColor="{DynamicResource TertiaryTextColor}"
                               ReturnCommand="{Binding SendCommand}"
                               Margin="15,0"/>
                    </Border>

                    <!-- Emoji Button -->
                    <Button Grid.Column="1"
                            Text="ðŸ˜Š"
                            Command="{Binding ShowEmojiPickerCommand}"
                            WidthRequest="45"
                            HeightRequest="45"
                            CornerRadius="22"
                            Padding="0"
                            FontSize="18"
                            BackgroundColor="{DynamicResource SecondaryColor}"/>

                    <!-- Voice Button -->
                    <Button Grid.Column="2"
                            Text="ðŸŽ¤"
                            Command="{Binding ToggleVoiceCommand}"
                            WidthRequest="45"
                            HeightRequest="45"
                            CornerRadius="22"
                            Padding="0"
                            FontSize="18"
                            BackgroundColor="{DynamicResource AccentColor}">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" 
                                       Binding="{Binding IsVoiceActive}" 
                                       Value="True">
                                <Setter Property="BackgroundColor" Value="{DynamicResource DangerColor}"/>
                                <Setter Property="Text" Value="ðŸ”´"/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>

                    <!-- Send Button -->
                    <Button Grid.Column="3"
                            Text="âž¤"
                            Command="{Binding SendCommand}"
                            IsEnabled="{Binding HasMessageText}"
                            WidthRequest="45"
                            HeightRequest="45"
                            CornerRadius="22"
                            Padding="0"
                            FontSize="20"
                            BackgroundColor="{DynamicResource PrimaryColor}"/>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</ContentPage>